pipeline {
    agent any
    
    environment {
      // ... other environment variables ...

        // Use Jenkins credentials for Docker Hub
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials-id')
        // myuser = credentials ('dockerhub-user')
        // mypassword = credentials ('dockerhub-password')

        POSTGRES_HOST = credentials ('POSTGRES_HOST')
        POSTGRES_PASSWORD = credentials ('POSTGRES_PASSWORD')
        AWS_ACCESS_KEY_ID = credentials ('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials ('AWS_SECRET_ACCESS_KEY')
        version = "v2"
        keyfile = credentials ('keyfile')
    }
    
    stages {
       stage ("download code") {
         steps {
            sh '''
            git clone https://github.com/github-kits26kat24/hr-app-project.git
           
            '''
         }
       }
    
       stage ("build image") {
         steps {
            sh '''
                  cd hr-app-project
                  docker build -t kitskat/hrrapp:$version .
               ''' || error "Failed to build Docker image"  
         }
       }

       stage ("publish image") {
         steps {
            script {
                // Use Jenkins credentials for Docker Hub
                withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'DOCKERHUB_CREDENTIALS', usernameVariable: 'DOCKERHUB_USERNAME', passwordVariable: 'DOCKERHUB_PASSWORD']]) {
                    // Log in to Docker Hub
                    sh "docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD"
                    
                    // Push the Docker image
                    sh "docker push kitskat/hrrapp:$version"
                }
            }
         }
       }

      //  stage ("publish image") {
      //    steps {
      //       sh '''
      //             docker login -u $myuser -p $mypassword
      //             docker push kitskat/hrrapp:$version
      //           '''
      //    }
      //  }       
    
       stage ("run image") {
         steps {
            sh '''
               ls
                 docker run --name hr-app-project-01  --rm -d -p 80:5000 kitskat/hrrapp:$version
               '''
         }
       }
           
    
       stage ("Run ansible") {
         steps {
            sh '''
                 cd HR-APP-PROJECT
                 cd ansible-home
                 pwd 
                 ls
                 ANSIBLE_HOST_KEY_CHECKING=false ansible-playbook -i inventory --key-file $keyfile playbook.yml -u ec2-user
                 # ANSIBLE_HOST_KEY_CHECKING=false ansible-playbook -i inventory  --key-file $keyfile playbookA.yml -u ec2-user 
               '''
         }
       }

    }

    post {
        always {
            deleteDir()
        }
    }
}